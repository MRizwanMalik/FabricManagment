{% extends 'base.html' %}

{% block content %}
<h1 class="text-3xl font-bold text-gray-800 mb-8">Wood Stock 🌳</h1>

<div class="flex justify-between items-center mb-6">
    <div class="relative">
        <input type="text" id="woodSearch" onkeyup="searchWood()" placeholder="Search by distributor name or ID..." class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 极 0 11-14 0 7 7 0 0114 0z"></path></svg>
    </div>
    <button class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-2 rounded-lg shadow-md transition duration-200 flex items-center space-x-2" onclick="openAddWoodModal()">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/s极"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m极 0v6m0-6h6m-6 0H6"></path></svg>
        <span>Add New Wood Stock</span>
    </button>
</div>

{% if total_wood %}
<div class="bg-blue-50 p-4 rounded-lg mb-6">
    <h3 class="text-lg font-semibold text-blue-800 mb-2">Total Wood Summary</h3>
    <div class="grid grid-cols-4 gap-4">
        <div class="bg-white p-3 rounded shadow">
            <p class="text-sm text-gray-600">Total Quantity</p>
            <p class="text-xl font-bold">{{ total_wood.total_quantity or 0 }} KG</p>
        </div>
        <div class="bg-white p-3 rounded shadow">
            <p class="text-sm text-gray-600">Total Amount</p>
            <p class="text-xl font-bold">Rs. {{ total_wood.total_amount or 0 }}</p>
        </div>
        <div class="bg-white p-3 rounded shadow">
            <p class="text-sm text-gray-600">Total Paid</p>
            <p class="text-xl font-bold">Rs. {{ total_wood.total_payment or 0 }}</p>
        </div>
        <div class="bg-white p-3 rounded shadow">
            <p class="text-sm text-gray-600">Total Remaining</p>
            <p class="text-xl font-bold">Rs. {{ total_wood.total_remaining or 0 }}</p>
        </div>
    </div>
</div>
{% endif %}

<div class="bg-white p-6 rounded-lg shadow-md overflow-x-auto">
    <table class="min-w-full bg-white border border-gray-200" id="woodTable">
        <thead>
            <tr>
                <th class="py-3 px-4 border-b text-left">ID</th>
                <th class="py-3 px-4 border-b text-left">Distributor Name</th>
                <th class="py-3 px-4 border-b text-left">Distributor ID</th>
                <th class="py-3 px-4 border-b text-left">Quantity (KG)</th>
                <th class="py-3 px-4 border-b text-left">Total Amount</th>
                <th class="py-3 px-4 border-b text-left">Payment</th>
                <th class="py-3极x-4 border-b text-left">Remaining</th>
                <th class="py-3 px-4 border-b text-left">Date Added</th>
                <th class="py-3 px-4 border-b text-left">Last Update</th>
                <th class="py-3 px-4 border-b text-left">Notes</th>
                <th class="py-3 px-4 border-b text-left">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for wood in wood_stock %}
            <tr>
                <td class="py-2 px-4 border-b">{{ wood.id }}</td>
                <td class="py-2 px-4 border-b">{{ wood.distributor_name }}</td>
                <td class="py-2 px-4 border-b">{{ wood.distributor_id }}</td>
                <td class="py-2 px-4 border-b">{{ wood.quantity_kg }}</td>
                <td class="py-2 px-4 border-b">{{ wood.total_amount }}</td>
                <td class="py-2 px-4 border-b">{{ wood.payment }}</td>
                <td class="py-2 px-4 border-b">{{ wood.remaining }}</td>
                <td class="py-2 px-4 border-b">{{ wood.date_added|datetimeformat }}</td>
                <td class="py-2 px-4 border-b">{{ wood.date_updated|datetimeformat if wood.date_updated else 'N/A' }}</td>
                <td class="py-2 px-4 border-b">{{ wood.notes if wood.notes else 'N/A' }}</td>
                <td class="py-2 px-4 border-b">
                    <button class="bg-green-500 text-white px-3 py-1 rounded-md text-sm hover:bg-green-600" onclick="openUsageModal({{ wood.id }}, 'wood', {{ wood.quantity_kg }})">Use</button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="11" class="py-2 px-4 text-center text-gray-500">No wood stock found.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div id="addWoodModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-8 rounded-lg shadow-xl w-1/3">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Add New Wood Stock</h3>
            <button class="text-gray-500 hover:text-gray-700" onclick="closeAddWoodModal()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form action="{{ url_for('add_wood') }}" method="POST">
            <div class="mb-4">
                <label for="distributorName" class="block text-gray-700 text-sm font-bold mb-2">Distributor Name:</label>
                <input type="text" id="distributorName" name="distributor_name" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>
            <div class="mb-4">
                <label for="distributorId" class="block text-gray-700 text-sm font-bold mb-2">Distributor ID:</label>
                <input type="text" id="distributorId" name="distributor_id" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="mb-4">
                <label for="quantityKg" class="block text-gray-700 text-sm font-bold mb-2">Quantity (KG):</label>
                <input type="number" step="0.01" id="quantityKg" name="quantity_kg" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>
            <div class="mb-4">
                <label for="totalAmount" class="block text-gray-700 text-sm font-bold mb-2">Total Amount:</label>
                <input type="number" step="0.01" id="totalAmount" name="total_amount" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
            </div>
            <div class="mb-4">
                <label for="payment" class="block text-gray-700 text-sm font-bold mb-2">Payment Made:</label>
                <input type="number" step="0.01" id="payment" name="payment" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" value="0">
            </div>
            <div class="mb-4">
                <label for="woodNotes" class="block text-gray-极0 text-sm font-bold mb-2">Notes:</label>
                <textarea id="woodNotes" name="notes" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
            </div>
            <div class="flex items-center justify-end">
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Add Stock
                </button>
            </div>
        </form>
    </div>
</div>

<div id="usageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-8 rounded-lg shadow-xl w-1/3">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Record Usage</h3>
            <button class="text-gray-500 hover:text-gray-700" onclick="closeUsageModal()">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6极12 12"></path></svg>
            </button>
        </div>
        <form id="usageForm" method="POST">
            <input type="hidden" id="usageItemId" name="item_id">
            <input type="hidden" id="usageItemType" name="item_type">
            <div class="mb-4">
                <label for="usedQuantity" class="block text-gray-700 text-sm font-bold mb-2">Quantity Used:</label>
                <input type="number" step="0.01" id="usedQuantity" name="used_quantity" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                <p class="text-xs text-gray-500 mt-1">Available: <span id="availableQuantity">0</span></p>
            </div>
            <div class="mb-4">
                <label for="usageNotes" class="block text-gray-700 text-sm font-bold mb-2">Usage Notes:</label>
                <textarea id="usageNotes" name="notes" rows="2" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
            </div>
            <div class="flex items-center justify-end">
                <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Record Usage
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    function openAddWoodModal() {
        document.getElementById('addWoodModal').classList.remove('hidden');
    }

    function closeAddWoodModal() {
        document.getElementById('addWoodModal').classList.add('hidden');
    }

    function openUsageModal(itemId, itemType, availableQty) {
        document.getElementById('usageItemId').value = itemId;
        document.getElementById('usageItemType').value = itemType;
        document.getElementById('availableQuantity').textContent = availableQty;
        document.getElementById('usedQuantity').setAttribute('max', availableQty);
        
        // Set form action based on item type
        if (itemType === 'wood') {
            document.getElementById('usageForm').action = `/update_wood_usage/${itemId}`;
        }
        
        document.getElementById('usageModal').classList.remove('hidden');
    }

    function closeUsageModal() {
        document.getElementById('usageModal').classList.add('hidden');
    }

    function searchWood() {
        var input, filter, table, tr, td, i, txtValue;
        input = document.getElementById("woodSearch");
        filter = input.value.toUpperCase();
        table = document.getElementById("woodTable");
        tr = table.getElementsByTagName("tr");

        for (i = 1; i < tr.length; i++) { // Start from 1 to skip header row
            td = tr[i].getElementsByTagName("td")[1]; // Distributor Name
            td2 = tr[i].getElementsByTagName("td")[2]; // Distributor ID
            if (td || td2) {
                txtValue = (td ? td.textContent || td.innerText : '') + " " + (td2 ? td2.textContent || td2.innerText : '');
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>
{% endblock %}